<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clippy TTS Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
        }

        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 3px;
            cursor: var(--cursor-pointer);
        }

        button:hover {
            background: #005a9e;
        }

        input,
        select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>

<body>
    <h1>Clippy TTS Integration Test</h1>

    <div class="test-section">
        <h2>TTS Support Check</h2>
        <div id="tts-status" class="status info">Checking TTS support...</div>
        <div id="voice-selection" style="display: none;">
            <label>Voice: <select id="voice-select"></select></label>
            <label>Rate: <input type="range" id="rate-slider" min="0.1" max="2" step="0.1" value="1"></label>
            <span id="rate-value">1.0</span>
            <label>Pitch: <input type="range" id="pitch-slider" min="0" max="2" step="0.1" value="1"></label>
            <span id="pitch-value">1.0</span>
            <label>Volume: <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1"></label>
            <span id="volume-value">1.0</span>
        </div>
    </div>

    <div class="test-section">
        <h2>Basic TTS Test</h2>
        <input type="text" id="tts-text" value="Hello! I can now speak with real voice synthesis!" size="50">
        <button onclick="testBasicTTS()">Test Basic TTS</button>
        <button onclick="testTTSWithOptions()">Test TTS with Options</button>
    </div>

    <div class="test-section">
        <h2>Clippy Agent Tests</h2>
        <div id="clippy-status" class="status info">Loading Clippy...</div>
        <button onclick="loadClippy()">Load Clippy Agent</button>
        <button onclick="testClippyTTS()" id="clippy-tts-btn" disabled>Test Clippy TTS</button>
        <button onclick="testClippySpeakAndAnimate()" id="clippy-anim-btn" disabled>Test with Animation</button>
        <button onclick="testClippyEmotion()" id="clippy-emotion-btn" disabled>Test Emotional Speech</button>
    </div>

    <div class="test-section">
        <h2>Advanced Tests</h2>
        <button onclick="testWordSync()">Test Word Synchronization</button>
        <button onclick="testFallback()">Test Fallback (No TTS)</button>
        <button onclick="stopAllSpeech()">Stop All Speech</button>
    </div>

    <!-- Load Clippy scripts -->
    <script src="public/clippy/clippy.js"></script>
    <script src="public/clippy/clippy_extensions_complete.js"></script>

    <script>
        let clippyAgent = null;
        let ttsSupported = false;

        // Initialize TTS support check
        window.addEventListener('load', function () {
            checkTTSSupport();
        });

        function checkTTSSupport() {
            const statusDiv = document.getElementById('tts-status');
            const voiceSelect = document.getElementById('voice-select');
            const voiceSection = document.getElementById('voice-selection');

            if ('speechSynthesis' in window) {
                ttsSupported = true;
                statusDiv.textContent = 'TTS is supported! Available voices: ' + speechSynthesis.getVoices().length;
                statusDiv.className = 'status success';

                // Populate voice selection
                function populateVoices() {
                    const voices = speechSynthesis.getVoices();
                    voiceSelect.innerHTML = '';
                    voices.forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice.name;
                        option.textContent = voice.name + ' (' + voice.lang + ')';
                        voiceSelect.appendChild(option);
                    });
                }

                populateVoices();
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = populateVoices;
                }

                voiceSection.style.display = 'block';

                // Update slider values
                document.getElementById('rate-slider').addEventListener('input', function () {
                    document.getElementById('rate-value').textContent = this.value;
                });
                document.getElementById('pitch-slider').addEventListener('input', function () {
                    document.getElementById('pitch-value').textContent = this.value;
                });
                document.getElementById('volume-slider').addEventListener('input', function () {
                    document.getElementById('volume-value').textContent = this.value;
                });

            } else {
                ttsSupported = false;
                statusDiv.textContent = 'TTS is not supported in this browser.';
                statusDiv.className = 'status error';
            }
        }

        function testBasicTTS() {
            if (!ttsSupported) {
                alert('TTS not supported!');
                return;
            }

            const text = document.getElementById('tts-text').value;
            const utterance = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.speak(utterance);
        }

        function testTTSWithOptions() {
            if (!ttsSupported) {
                alert('TTS not supported!');
                return;
            }

            const text = document.getElementById('tts-text').value;
            const utterance = new SpeechSynthesisUtterance(text);

            // Apply options
            const voiceSelect = document.getElementById('voice-select');
            const voices = speechSynthesis.getVoices();
            const selectedVoice = voices.find(v => v.name === voiceSelect.value);
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }

            utterance.rate = parseFloat(document.getElementById('rate-slider').value);
            utterance.pitch = parseFloat(document.getElementById('pitch-slider').value);
            utterance.volume = parseFloat(document.getElementById('volume-slider').value);

            window.speechSynthesis.speak(utterance);
        }

        function loadClippy() {
            const statusDiv = document.getElementById('clippy-status');

            clippy.load('Clippy', function (agent) {
                clippyAgent = agent;
                statusDiv.textContent = 'Clippy loaded successfully!';
                statusDiv.className = 'status success';

                // Enable test buttons
                document.getElementById('clippy-tts-btn').disabled = false;
                document.getElementById('clippy-anim-btn').disabled = false;
                document.getElementById('clippy-emotion-btn').disabled = false;

                // Show Clippy
                agent.show();
                agent.moveTo(200, 200);
            }, function () {
                statusDiv.textContent = 'Failed to load Clippy!';
                statusDiv.className = 'status error';
            });
        }

        function testClippyTTS() {
            if (!clippyAgent) return;

            const text = document.getElementById('tts-text').value;

            // Configure TTS options from sliders
            const ttsOptions = {
                rate: parseFloat(document.getElementById('rate-slider').value),
                pitch: parseFloat(document.getElementById('pitch-slider').value),
                volume: parseFloat(document.getElementById('volume-slider').value)
            };

            const voiceSelect = document.getElementById('voice-select');
            const voices = speechSynthesis.getVoices();
            const selectedVoice = voices.find(v => v.name === voiceSelect.value);
            if (selectedVoice) {
                ttsOptions.voice = selectedVoice;
            }

            clippyAgent.speakWithTTS(text, {
                ttsOptions: ttsOptions,
                callback: function () {
                    console.log('Clippy TTS completed');
                }
            });
        }

        function testClippySpeakAndAnimate() {
            if (!clippyAgent) return;

            const text = "I can speak and animate at the same time!";

            // Configure TTS options
            const ttsOptions = {
                rate: parseFloat(document.getElementById('rate-slider').value),
                pitch: parseFloat(document.getElementById('pitch-slider').value),
                volume: parseFloat(document.getElementById('volume-slider').value)
            };

            const voiceSelect = document.getElementById('voice-select');
            const voices = speechSynthesis.getVoices();
            const selectedVoice = voices.find(v => v.name === voiceSelect.value);
            if (selectedVoice) {
                ttsOptions.voice = selectedVoice;
            }

            clippyAgent.speakAndAnimate(text, 'Explain', {
                useTTS: true,
                ttsOptions: ttsOptions,
                callback: function () {
                    console.log('Clippy speak and animate completed');
                }
            });
        }

        function testClippyEmotion() {
            if (!clippyAgent) return;

            const text = "I can express emotions while speaking!";

            // Configure TTS options
            const ttsOptions = {
                rate: parseFloat(document.getElementById('rate-slider').value),
                pitch: parseFloat(document.getElementById('pitch-slider').value),
                volume: parseFloat(document.getElementById('volume-slider').value)
            };

            const voiceSelect = document.getElementById('voice-select');
            const voices = speechSynthesis.getVoices();
            const selectedVoice = voices.find(v => v.name === voiceSelect.value);
            if (selectedVoice) {
                ttsOptions.voice = selectedVoice;
            }

            clippyAgent.speakWithEmotion(text, 'excited', {
                useTTS: true,
                ttsOptions: ttsOptions,
                callback: function () {
                    console.log('Clippy emotional speech completed');
                }
            });
        }

        function testWordSync() {
            if (!clippyAgent) return;

            const text = "This demonstrates perfect synchronization between speech and text display.";

            clippyAgent.speakWithTTS(text, {
                ttsOptions: { rate: 0.8 }, // Slightly slower for better demo
                callback: function () {
                    console.log('Word sync test completed');
                }
            });
        }

        function testFallback() {
            if (!clippyAgent) return;

            // Temporarily disable TTS to test fallback
            const originalTTSEnabled = clippyAgent._balloon._ttsEnabled;
            clippyAgent._balloon._ttsEnabled = false;

            const text = "This should fall back to visual-only speech since TTS is disabled.";

            clippyAgent.speak(text, false, true); // Try TTS but it will fallback

            // Restore TTS
            setTimeout(function () {
                clippyAgent._balloon._ttsEnabled = originalTTSEnabled;
            }, 1000);
        }

        function stopAllSpeech() {
            if (clippyAgent) {
                clippyAgent.stopTTS();
            }
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
        }
    </script>
</body>

</html>