<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Commander Keen</title>
    <style>
      body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: black;
      }
      .emscripten_border {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
      }
      canvas.emscripten {
        border: 0px none;
        background-color: black;
      }
    </style>
  </head>
  <body>
    <div class="emscripten_border">
      <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex=-1></canvas>
    </div>
    <script type='text/javascript'>
      var Module = {
        preRun: [],
        postRun: [],
        onRuntimeInitialized: () => {
          // Load all save games from localStorage
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith("keen_save_")) {
              const filename = key.substring(
                "keen_save_".length,
              );
              const savedGame = localStorage.getItem(key);
              if (savedGame) {
                try {
                  const binaryString = atob(savedGame);
                  const len = binaryString.length;
                  const bytes = new Uint8Array(len);
                  for (let j = 0; j < len; j++) {
                    bytes[j] =
                      binaryString.charCodeAt(j);
                  }
                  ensureDirectoryExistence(filename); // Ensure parent directories exist
                  const parentDir =
                    filename.substring(
                      0,
                      filename.lastIndexOf("/"),
                    ) || "/";
                  const baseFilename = filename.substring(
                    filename.lastIndexOf("/") + 1,
                  );

                  Module.FS_createDataFile(
                    parentDir,
                    baseFilename,
                    bytes,
                    true,
                    true,
                    true,
                  );
                  console.log(
                    `Loaded ${filename} from localStorage.`,
                  );
                } catch (e) {
                  console.error(
                    `Failed to load ${filename} from localStorage:`,
                    e,
                  );
                }
              }
            }
          }
        },
        canvas: (function() {
          var canvas = document.getElementById('canvas');
          canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);
          return canvas;
        })(),
      };

      function ensureDirectoryExistence(filePath) {
        let dirname = filePath.substring(0, filePath.lastIndexOf("/"));
        if (dirname === "" || dirname === "/") return; // No directory or root

        let parts = dirname.split("/").filter((p) => p !== "");
        let currentPath = "";
        for (let i = 0; i < parts.length; i++) {
          currentPath += "/" + parts[i];
          try {
            Module.FS.stat(currentPath);
          } catch (e) {
            // Directory does not exist, create it
            Module.FS.mkdir(currentPath);
            console.log(`Created directory: ${currentPath}`);
          }
        }
      }

      function readAllFiles(path) {
        let allFiles = [];
        let filesInDir = Module.FS.readdir(path);
        // Remove '.' and '..' special entries
        filesInDir = filesInDir.filter(
            (entry) => entry !== "." && entry !== "..",
        );

        filesInDir.forEach((entry) => {
            // Construct the full path for the current entry
            const fullPath =
                path === "/" ? `/${entry}` : `${path}/${entry}`;
            try {
                const stat = Module.FS.stat(fullPath);
                if (Module.FS.isDir(stat.mode)) {
                    // If it's a directory, recursively read its contents
                    allFiles = allFiles.concat(readAllFiles(fullPath));
                } else if (Module.FS.isFile(stat.mode)) {
                    // If it's a file, add its full path to the list
                    allFiles.push(fullPath);
                }
            } catch (e) {
                console.warn(`Could not stat ${fullPath}: ${e}`);
            }
        });
        return allFiles;
      }

      function saveKeenProgress() {
        try {
            const files = readAllFiles("/"); // Get all files recursively
            files.forEach((file) => {
                const filenameOnly = file.substring(
                    file.lastIndexOf("/") + 1,
                );
                if (
                    filenameOnly.toUpperCase() === "SCORES.CK1" ||
                    (filenameOnly.toUpperCase().startsWith("SAVED") && filenameOnly.toUpperCase().endsWith(".CK1"))
                ) {
                    const fileData = Module.FS.readFile(file, {
                        encoding: "binary",
                    });
                    if (fileData) {
                        let binary = "";
                        const bytes = new Uint8Array(fileData);
                        const len = bytes.byteLength;
                        for (let i = 0; i < len; i++) {
                            binary += String.fromCharCode(bytes[i]);
                        }
                        const base64Data = btoa(binary);
                        localStorage.setItem(
                            `keen_save_${file}`,
                            base64Data,
                        );
                        console.log(`Saved ${file} to localStorage.`);
                    }
                }
            });
        } catch (e) {
            console.error("Failed to save game to localStorage:", e);
        }
      }
      window.saveKeenProgress = saveKeenProgress;
      window.addEventListener("beforeunload", saveKeenProgress);
    </script>
    <script>
      var emterpretURL = 'data.binary';
      var emterpretXHR = new XMLHttpRequest();
      emterpretXHR.open('GET', emterpretURL, true);
      emterpretXHR.responseType = 'arraybuffer';
      emterpretXHR.onload = function() {
        if (emterpretXHR.status === 200 || emterpretXHR.status === 0) {
          Module.emterpreterFile = emterpretXHR.response;
        }
        var script = document.createElement('script');
        script.src = "chocolate-keen.js";
        document.body.appendChild(script);
      };
      emterpretXHR.send(null);
    </script>
  </body>
</html>
