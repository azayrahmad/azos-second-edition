<!doctype html>
<html lang="en-us">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>3D Pinball for Windows - Space Cadet</title>
        <style>
            body {
                font-family: Tahoma, Geneva, Verdana, sans-serif;
                background-color: #000;
                text-align: center;
                color: white;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
            .emscripten-container {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 100vh;
            }
            canvas.emscripten {
                border: 0 none;
                background-color: #000;
            }
            #splash-image {
                /* display at native size */
            }
        </style>
    </head>
    <body>
        <div class="emscripten-container">
            <img
                id="splash-image"
                src="./SPLASH_BITMAP.bmp"
                alt="3D Pinball for Windows - Space Cadet"
                style="display: block"
            />
            <canvas
                class="emscripten"
                id="canvas"
                oncontextmenu="event.preventDefault()"
                style="display: none"
                tabindex="-1"
            ></canvas>
        </div>

        <script>
            var Module = {
                print: function (text) {
                    console.log(text);
                },
                printErr: function (text) {
                    console.error(text);
                },
                canvas: (function () {
                    var canvas = document.getElementById("canvas");
                    canvas.addEventListener(
                        "webglcontextlost",
                        function (e) {
                            alert("WebGL context lost. Reload the page.");
                            e.preventDefault();
                        },
                        false,
                    );
                    return canvas;
                })(),
                setStatus: function (text) {
                    if (!Module.setStatus.last)
                        Module.setStatus.last = { time: Date.now(), text: "" };
                    if (text === Module.setStatus.last.text) return; // Prevent duplicate console logs for the same status

                    var now = Date.now();
                    // Throttle logging to avoid excessive console output for rapid updates
                    if (now - Module.setStatus.last.time < 30) return;

                    Module.setStatus.last.time = now;
                    Module.setStatus.last.text = text;

                    if (text === "") {
                        console.log("Loading complete.");
                    } else {
                        console.log("Loading status: " + text);
                    }
                },
                totalDependencies: 0,
                monitorRunDependencies: function (left) {
                    this.totalDependencies = Math.max(
                        this.totalDependencies,
                        left,
                    );
                    const statusText = left
                        ? "Preparing... (" +
                          (this.totalDependencies - left) +
                          "/" +
                          this.totalDependencies +
                          ")"
                        : "All downloads complete.";
                    console.log(statusText);
                },
                onRuntimeInitialized: function () {
                    document.getElementById("splash-image").style.display =
                        "none";
                    document.getElementById("canvas").style.display = "block";

                    function logFileSystem() {
                        console.log('--- Logging Pinball FS ---');
                        const allFiles = readAllFiles("/");
                        console.log("All files in FS:", allFiles);
                    }

                    function readAllFiles(path) {
                        let allFiles = [];
                        try {
                            let filesInDir = Module.FS.readdir(path);
                            filesInDir = filesInDir.filter(
                                (entry) => entry !== "." && entry !== "..",
                            );
                            filesInDir.forEach((entry) => {
                                const fullPath =
                                    path === "/" ? `/${entry}` : `${path}/${entry}`;
                                try {
                                    const stat = Module.FS.stat(fullPath);
                                    if (Module.FS.isDir(stat.mode)) {
                                        allFiles = allFiles.concat(readAllFiles(fullPath));
                                    } else if (Module.FS.isFile(stat.mode)) {
                                        allFiles.push(fullPath);
                                    }
                                } catch (e) {}
                            });
                        } catch (e) {}
                        return allFiles;
                    }

                    function loadPinballDat() {
                        const savedGame = localStorage.getItem('pinball.dat');
                        if (savedGame) {
                            try {
                                const binaryString = atob(savedGame);
                                const len = binaryString.length;
                                const bytes = new Uint8Array(len);
                                for (let i = 0; i < len; i++) {
                                    bytes[i] = binaryString.charCodeAt(i);
                                }
                                Module.FS_createDataFile(
                                    "/",
                                    "pinball.dat",
                                    bytes,
                                    true,
                                    true,
                                    true
                                );
                                console.log('Loaded pinball.dat from localStorage.');
                            } catch (e) {
                                console.error('Failed to load pinball.dat from localStorage:', e);
                            }
                        }
                    }

                    function savePinballDat() {
                        try {
                            const fileData = Module.FS.readFile("/pinball.dat", {
                                encoding: "binary",
                            });
                            if (fileData) {
                                let binary = "";
                                const bytes = new Uint8Array(fileData);
                                const len = bytes.byteLength;
                                for (let i = 0; i < len; i++) {
                                    binary += String.fromCharCode(bytes[i]);
                                }
                                const base64Data = btoa(binary);
                                localStorage.setItem(
                                    'pinball.dat',
                                    base64Data,
                                );
                                console.log('Saved pinball.dat to localStorage.');
                            }
                        } catch (e) {
                            console.error("Failed to save pinball.dat to localStorage:", e);
                        }
                    }

                    window.logFileSystem = logFileSystem;
                    window.savePinballDat = savePinballDat;

                    loadPinballDat();
                },
            };

            window.onerror = function () {
                Module.setStatus("Exception thrown, see JavaScript console");
                Module.setStatus = function (text) {
                    if (text)
                        Module.printErr("[post-exception status] " + text);
                };
            };
        </script>

        <script async src="SpaceCadetPinball.js"></script>
    </body>
</html>
