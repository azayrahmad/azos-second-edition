<!doctype html>
<html lang="en-us">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>3D Pinball for Windows - Space Cadet</title>
        <style>
            body {
                font-family: Tahoma, Geneva, Verdana, sans-serif;
                background-color: #000;
                text-align: center;
                color: white;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
            .emscripten-container {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 100vh;
            }
            canvas.emscripten {
                border: 0 none;
                background-color: #000;
            }
            #splash-image {
                /* display at native size */
            }
        </style>
    </head>
    <body>
        <div class="emscripten-container">
            <img
                id="splash-image"
                src="./SPLASH_BITMAP.bmp"
                alt="3D Pinball for Windows - Space Cadet"
                style="display: block"
            />
            <canvas
                class="emscripten"
                id="canvas"
                oncontextmenu="event.preventDefault()"
                style="display: none"
                tabindex="-1"
            ></canvas>
        </div>

        <script>
            var Module = {
                preRun: [function() {
                    // Pre-load root folder from IndexedDB
                    FS.mount(IDBFS, {}, '/');
                    FS.syncfs(true, function (err) {
                        if (err) {
                            console.error('Error loading data from IndexedDB:', err);
                        } else {
                            console.log('Successfully loaded data from IndexedDB.');
                        }
                    });
                }],
                print: function (text) {
                    console.log(text);
                },
                printErr: function (text) {
                    console.error(text);
                },
                canvas: (function () {
                    var canvas = document.getElementById("canvas");
                    canvas.addEventListener(
                        "webglcontextlost",
                        function (e) {
                            alert("WebGL context lost. Reload the page.");
                            e.preventDefault();
                        },
                        false,
                    );
                    return canvas;
                })(),
                setStatus: function (text) {
                    if (!Module.setStatus.last)
                        Module.setStatus.last = { time: Date.now(), text: "" };
                    if (text === Module.setStatus.last.text) return; // Prevent duplicate console logs for the same status

                    var now = Date.now();
                    // Throttle logging to avoid excessive console output for rapid updates
                    if (now - Module.setStatus.last.time < 30) return;

                    Module.setStatus.last.time = now;
                    Module.setStatus.last.text = text;

                    if (text === "") {
                        console.log("Loading complete.");
                    } else {
                        console.log("Loading status: " + text);
                    }
                },
                totalDependencies: 0,
                monitorRunDependencies: function (left) {
                    this.totalDependencies = Math.max(
                        this.totalDependencies,
                        left,
                    );
                    const statusText = left
                        ? "Preparing... (" +
                          (this.totalDependencies - left) +
                          "/" +
                          this.totalDependencies +
                          ")"
                        : "All downloads complete.";
                    console.log(statusText);
                },
                onRuntimeInitialized: function () {
                    document.getElementById("splash-image").style.display =
                        "none";
                    document.getElementById("canvas").style.display = "block";

                    // Periodically sync the file system to IndexedDB
                    setInterval(function() {
                        FS.syncfs(false, function (err) {
                            if (err) {
                                console.error('Error saving data to IndexedDB:', err);
                            }
                        });
                    }, 5000); // Sync every 5 seconds
                },
            };

            window.onerror = function () {
                Module.setStatus("Exception thrown, see JavaScript console");
                Module.setStatus = function (text) {
                    if (text)
                        Module.printErr("[post-exception status] " + text);
                };
            };
        </script>

        <script async src="SpaceCadetPinball.js"></script>
    </body>
</html>
