<!doctype html>
<html lang="en-us">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>3D Pinball for Windows - Space Cadet</title>
        <style>
            body {
                font-family: Tahoma, Geneva, Verdana, sans-serif;
                background-color: #000;
                text-align: center;
                color: white;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
            .emscripten-container {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 100vh;
            }
            canvas.emscripten {
                border: 0 none;
                background-color: #000;
            }
            #splash-image {
                /* display at native size */
            }
        </style>
    </head>
    <body>
        <div class="emscripten-container">
            <img
                id="splash-image"
                src="./SPLASH_BITMAP.bmp"
                alt="3D Pinball for Windows - Space Cadet"
                style="display: block"
            />
            <canvas
                class="emscripten"
                id="canvas"
                oncontextmenu="event.preventDefault()"
                style="display: none"
                tabindex="-1"
            ></canvas>
        </div>

        <script>
            var Module = {
                preRun: [],
                postRun: [],
                print: function (text) {
                    console.log(text);
                },
                printErr: function (text) {
                    console.error(text);
                },
                canvas: (function () {
                    var canvas = document.getElementById("canvas");
                    canvas.addEventListener(
                        "webglcontextlost",
                        function (e) {
                            alert("WebGL context lost. Reload the page.");
                            e.preventDefault();
                        },
                        false,
                    );
                    return canvas;
                })(),
                setStatus: function (text) {
                    if (!Module.setStatus.last)
                        Module.setStatus.last = { time: Date.now(), text: "" };
                    if (text === Module.setStatus.last.text) return; // Prevent duplicate console logs for the same status

                    var now = Date.now();
                    // Throttle logging to avoid excessive console output for rapid updates
                    if (now - Module.setStatus.last.time < 30) return;

                    Module.setStatus.last.time = now;
                    Module.setStatus.last.text = text;

                    if (text === "") {
                        console.log("Loading complete.");
                    } else {
                        console.log("Loading status: " + text);
                    }
                },
                totalDependencies: 0,
                monitorRunDependencies: function (left) {
                    this.totalDependencies = Math.max(
                        this.totalDependencies,
                        left,
                    );
                    const statusText = left
                        ? "Preparing... (" +
                          (this.totalDependencies - left) +
                          "/" +
                          this.totalDependencies +
                          ")"
                        : "All downloads complete.";
                    console.log(statusText);
                },
                // âœ… Add this: ensure canvas is revealed when runtime is ready
                onRuntimeInitialized: function () {
                    document.getElementById("splash-image").style.display =
                        "none";
                    document.getElementById("canvas").style.display = "block";
                },
            };

            window.onerror = function () {
                Module.setStatus("Exception thrown, see JavaScript console");
                Module.setStatus = function (text) {
                    if (text)
                        Module.printErr("[post-exception status] " + text);
                };
            };
        </script>

        <script>
            function readAllFiles(path) {
                let allFiles = [];
                if (!Module.FS || !Module.FS.readdir) {
                    // console.log('FS not ready yet.');
                    return allFiles;
                }
                try {
                    let filesInDir = Module.FS.readdir(path);
                    // Remove '.' and '..' special entries
                    filesInDir = filesInDir.filter(
                        (entry) => entry !== "." && entry !== "..",
                    );

                    filesInDir.forEach((entry) => {
                        // Construct the full path for the current entry
                        const fullPath =
                            path === "/" ? `/${entry}` : `${path}/${entry}`;
                        try {
                            const stat = Module.FS.stat(fullPath);
                            if (Module.FS.isDir(stat.mode)) {
                                // If it's a directory, recursively read its contents
                                allFiles = allFiles.concat(readAllFiles(fullPath));
                            } else if (Module.FS.isFile(stat.mode)) {
                                // If it's a file, add its full path to the list
                                allFiles.push(fullPath);
                            }
                        } catch (e) {
                            // ignore errors for now
                        }
                    });
                } catch (e) {
                    // ignore fs errors
                }
                return allFiles;
            }

            function logFileSystem() {
                if (!Module.FS) return;
                console.log('--- Logging Pinball FS ---');
                const allFiles = readAllFiles("/");
                console.log("All files in FS:", allFiles);

                allFiles.forEach(file => {
                    try {
                        const fileData = Module.FS.readFile(file, { encoding: 'binary' });
                        if (fileData) {
                             let binary = "";
                            const bytes = new Uint8Array(fileData);
                            const len = bytes.byteLength;
                            for (let i = 0; i < len; i++) {
                                binary += String.fromCharCode(bytes[i]);
                            }
                            const base64Data = btoa(binary);
                            console.log(`Content of ${file} (base64):`, base64Data);
                        }
                    } catch(e) {
                        console.error(`Could not read file ${file}`, e);
                    }
                });
                console.log('--- End Pinball FS Log ---');
            }

            // Expose to parent window
            window.logFileSystem = logFileSystem;

            // Log FS periodically
            setInterval(logFileSystem, 5000);

            // Log FS on close
            window.addEventListener("beforeunload", logFileSystem);
        </script>

        <script async src="SpaceCadetPinball.js"></script>
    </body>
</html>
