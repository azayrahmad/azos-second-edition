<!doctype html>
<html lang="en-us">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>3D Pinball for Windows - Space Cadet</title>
        <style>
            body {
                font-family: Tahoma, Geneva, Verdana, sans-serif;
                background-color: #000;
                text-align: center;
                color: white;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
            .emscripten-container {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 100vh;
            }
            canvas.emscripten {
                border: 0 none;
                background-color: #000;
            }
            #status {
                margin: 20px;
            }
        </style>
    </head>
    <body>
        <div class="emscripten-container">
            <div class="emscripten" id="status">Downloading...</div>
            <div class="emscripten">
                <progress hidden id="progress" max="100" value="0"></progress>
            </div>
            <canvas
                class="emscripten"
                id="canvas"
                oncontextmenu="event.preventDefault()"
                style="display: none"
                tabindex="-1"
            ></canvas>
        </div>

        <script>
            var statusElement = document.getElementById("status");
            var progressElement = document.getElementById("progress");

            var Module = {
                preRun: [],
                postRun: [],
                print: function (text) {
                    console.log(text);
                },
                printErr: function (text) {
                    console.error(text);
                },
                canvas: (function () {
                    var canvas = document.getElementById("canvas");
                    canvas.addEventListener(
                        "webglcontextlost",
                        function (e) {
                            alert("WebGL context lost. Reload the page.");
                            e.preventDefault();
                        },
                        false,
                    );
                    return canvas;
                })(),
                setStatus: function (text) {
                    if (!Module.setStatus.last)
                        Module.setStatus.last = { time: Date.now(), text: "" };
                    if (text === Module.setStatus.last.text) return;
                    var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
                    var now = Date.now();
                    if (m && now - Module.setStatus.last.time < 30) return;
                    Module.setStatus.last.time = now;
                    Module.setStatus.last.text = text;
                    if (m) {
                        text = m[1];
                        progressElement.value = parseInt(m[2]) * 100;
                        progressElement.max = parseInt(m[4]) * 100;
                        progressElement.hidden = false;
                    } else {
                        progressElement.hidden = true;
                        if (text === "") {
                            document.getElementById("canvas").style.display =
                                "block";
                        }
                    }
                    statusElement.innerHTML = text;
                },
                totalDependencies: 0,
                monitorRunDependencies: function (left) {
                    this.totalDependencies = Math.max(
                        this.totalDependencies,
                        left,
                    );
                    Module.setStatus(
                        left
                            ? "Preparing... (" +
                                  (this.totalDependencies - left) +
                                  "/" +
                                  this.totalDependencies +
                                  ")"
                            : "All downloads complete.",
                    );
                },
                // âœ… Add this: ensure canvas is revealed when runtime is ready
                onRuntimeInitialized: function () {
                    document.getElementById("status").style.display = "none";
                    document.getElementById("progress").style.display = "none";
                    document.getElementById("canvas").style.display = "block";
                    // Start score monitoring
                    monitorScore();
                },
            };

            function monitorScore() {
                const POINTER_SIZE = 4;
                const GAME_MODE_OFFSET = 24;
                const MAIN_TABLE_OFFSET = 28;
                const PLAYER_SCORES_OFFSET = 88;
                const SCORE_OFFSET = 4;

                let gameModePtr, mainTablePtr, playerScoresPtr, scorePtr;
                let lastGameMode = -1;

                const intervalId = setInterval(() => {
                    if (Module.HEAP32) {
                        if (!gameModePtr) {
                            const base = Module.asm.get_g_pb_pinball_table();
                            if (!base) return;
                            gameModePtr = (base + GAME_MODE_OFFSET) / POINTER_SIZE;
                            mainTablePtr = (base + MAIN_TABLE_OFFSET) / POINTER_SIZE;
                            const mainTable = Module.HEAP32[mainTablePtr];
                            playerScoresPtr = (mainTable + PLAYER_SCORES_OFFSET) / POINTER_SIZE;
                        }

                        const gameMode = Module.HEAP32[gameModePtr];

                        if (gameMode === 2 && lastGameMode !== 2) {
                            const scores = [];
                            for (let i = 0; i < 4; i++) {
                                scorePtr = (playerScoresPtr + i * 28 + SCORE_OFFSET) / POINTER_SIZE;
                                scores.push(Module.HEAP32[scorePtr]);
                            }
                            parent.postMessage({
                                type: 'PINBALL_GAME_OVER',
                                payload: { scores }
                            }, window.location.origin);
                        }

                        lastGameMode = gameMode;
                    }
                }, 1000); // Check every second
            }

            Module.setStatus("Downloading...");
            window.onerror = function () {
                Module.setStatus("Exception thrown, see JavaScript console");
                Module.setStatus = function (text) {
                    if (text)
                        Module.printErr("[post-exception status] " + text);
                };
            };
        </script>

        <script async src="SpaceCadetPinball.js"></script>
    </body>
</html>
