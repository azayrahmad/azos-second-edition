<!doctype html>
<html lang="en-us">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>3D Pinball for Windows - Space Cadet</title>
        <style>
            body {
                font-family: Tahoma, Geneva, Verdana, sans-serif;
                background-color: #000;
                text-align: center;
                color: white;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
            .emscripten-container {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 100vh;
            }
            canvas.emscripten {
                border: 0 none;
                background-color: #000;
            }
            #status {
                margin: 20px;
            }
        </style>
    </head>
    <body>
        <div class="emscripten-container">
            <div class="emscripten" id="status">Downloading...</div>
            <div class="emscripten">
                <progress hidden id="progress" max="100" value="0"></progress>
            </div>
            <canvas
                class="emscripten"
                id="canvas"
                oncontextmenu="event.preventDefault()"
                style="display: none"
                tabindex="-1"
            ></canvas>
        </div>

        <script>
            var statusElement = document.getElementById("status");
            var progressElement = document.getElementById("progress");

            var Module = {
                preRun: [],
                postRun: [],
                print: function (text) {
                    console.log(text);
                },
                printErr: function (text) {
                    console.error(text);
                },
                canvas: (function () {
                    var canvas = document.getElementById("canvas");
                    canvas.addEventListener(
                        "webglcontextlost",
                        function (e) {
                            alert("WebGL context lost. Reload the page.");
                            e.preventDefault();
                        },
                        false,
                    );
                    return canvas;
                })(),
                setStatus: function (text) {
                    if (!Module.setStatus.last)
                        Module.setStatus.last = { time: Date.now(), text: "" };
                    if (text === Module.setStatus.last.text) return;
                    var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
                    var now = Date.now();
                    if (m && now - Module.setStatus.last.time < 30) return;
                    Module.setStatus.last.time = now;
                    Module.setStatus.last.text = text;
                    if (m) {
                        text = m[1];
                        progressElement.value = parseInt(m[2]) * 100;
                        progressElement.max = parseInt(m[4]) * 100;
                        progressElement.hidden = false;
                    } else {
                        progressElement.hidden = true;
                        if (text === "") {
                            document.getElementById("canvas").style.display =
                                "block";
                        }
                    }
                    statusElement.innerHTML = text;
                },
                totalDependencies: 0,
                monitorRunDependencies: function (left) {
                    this.totalDependencies = Math.max(
                        this.totalDependencies,
                        left,
                    );
                    Module.setStatus(
                        left
                            ? "Preparing... (" +
                                  (this.totalDependencies - left) +
                                  "/" +
                                  this.totalDependencies +
                                  ")"
                            : "All downloads complete.",
                    );
                },
                // âœ… Add this: ensure canvas is revealed when runtime is ready
                onRuntimeInitialized: function () {
                    document.getElementById("status").style.display = "none";
                    document.getElementById("progress").style.display = "none";
                    document.getElementById("canvas").style.display = "block";
                    // Start score monitoring
                    monitorScore();
                },
            };

            function monitorScore() {
                const POINTER_SIZE = 4;
                const SCORE_OFFSET = 0x22068;
                const GAME_STATE_OFFSET = 0x22050;

                let scorePtr;
                let gameStatePtr;
                let lastScore = -1;
                let wasGameOver = true;

                const intervalId = setInterval(() => {
                    if (Module.HEAP32) {
                        if (!scorePtr) {
                            const base = Module.asm.get_g_pb_pinball_table();
                            if (!base) return;
                            scorePtr = (base + SCORE_OFFSET) / POINTER_SIZE;
                            gameStatePtr = (base + GAME_STATE_OFFSET) / POINTER_SIZE;
                        }

                        const score = Module.HEAP32[scorePtr];
                        const isGameOver = Module.HEAP32[gameStatePtr] === 1;

                        if (score !== lastScore) {
                            lastScore = score;
                        }

                        // Game just ended
                        if (isGameOver && !wasGameOver) {
                            parent.postMessage({
                                type: 'PINBALL_GAME_OVER',
                                payload: { score: lastScore }
                            }, window.location.origin);
                        }

                        wasGameOver = isGameOver;
                    }
                }, 1000); // Check every second
            }

            Module.setStatus("Downloading...");
            window.onerror = function () {
                Module.setStatus("Exception thrown, see JavaScript console");
                Module.setStatus = function (text) {
                    if (text)
                        Module.printErr("[post-exception status] " + text);
                };
            };
        </script>

        <script async src="SpaceCadetPinball.js"></script>
    </body>
</html>
